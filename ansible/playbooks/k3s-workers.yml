- name: Deploy K3S Workers
  hosts: workers
  become: yes
  
  tasks:
    - name: Check if K3S agent is already installed
      stat:
        path: /usr/local/bin/k3s-agent-uninstall.sh
      register: k3s_agent_binary
    
    # Pre-flight checks
    - name: Test VIP connectivity from workers
      shell: curl -k -m 5 https://{{ vip_address }}:6443/ping
      register: vip_ping_test
      failed_when: false
      changed_when: false
      when: not k3s_agent_binary.stat.exists
    
    - name: Fail if VIP not responding
      fail:
        msg: |
          ❌ Cannot reach VIP {{ vip_address }}:6443 from {{ inventory_hostname }}
          
          Result: {{ vip_ping_test.stdout }}
          
          Fix:
            1. Ensure HAProxy is running: ansible-playbook -i inventory.yml playbooks/verify-haproxy-k3s.yml
            2. Test from worker: curl -k https://{{ vip_address }}:6443/ping
      when:
        - not k3s_agent_binary.stat.exists
        - vip_ping_test is defined
        - "'pong' not in vip_ping_test.stdout"
    
    - name: Verify K3S token exists
      stat:
        path: /tmp/k3s-server-token
      delegate_to: localhost
      register: token_file
      run_once: yes
      become: no
      when: not k3s_agent_binary.stat.exists
    
    - name: Get token from master if missing
      shell: cat /var/lib/rancher/k3s/server/node-token
      delegate_to: "{{ groups['masters'][0] }}"
      register: master_token
      become: yes
      run_once: yes
      when:
        - not k3s_agent_binary.stat.exists
        - token_file is defined
        - not token_file.stat.exists
    
    - name: Save token locally if fetched
      copy:
        content: "{{ master_token.stdout }}"
        dest: /tmp/k3s-server-token
        mode: '0600'
      delegate_to: localhost
      become: no
      run_once: yes
      when:
        - master_token is defined
        - master_token.stdout is defined
    
    - name: Install K3S agent on workers
      shell: |
        curl -sfL https://get.k3s.io | \
        K3S_TOKEN="{{ lookup('file', '/tmp/k3s-server-token') }}" \
        K3S_URL="https://{{ vip_address }}:6443" \
        INSTALL_K3S_VERSION="{{ k3s_version }}" \
        sh -s - agent \
          --node-ip="{{ ansible_host }}" \
          --node-name="{{ inventory_hostname }}" \
          --server https://{{ vip_address }}:6443 \
          --kubelet-arg="fail-swap-on=false"
      args:
        creates: /usr/local/bin/k3s-agent-uninstall.sh
      register: k3s_agent_install
      async: 300
      poll: 10
      retries: 3
      delay: 10
      until: k3s_agent_install.rc == 0
      when: not k3s_agent_binary.stat.exists
    
    - name: Wait for K3S agent service to start
      systemd:
        name: k3s-agent
        state: started
      register: k3s_agent_service
    
    - name: Wait for agent to initialize
      pause:
        seconds: 15
    
    - name: Check K3S agent status
      shell: systemctl is-active k3s-agent
      register: agent_active
      changed_when: false
      failed_when: false
    
    - name: Get agent logs if issues
      shell: journalctl -xeu k3s-agent.service --no-pager | tail -30
      register: agent_logs
      when: agent_active.stdout != "active"
      failed_when: false
    
    - name: Display agent status
      debug:
        msg: |
          {% if agent_active.stdout == "active" %}
          ✅ K3S agent running on {{ inventory_hostname }}
          {% else %}
          ⚠️  K3S agent status: {{ agent_active.stdout }}
          
          Recent logs:
          {{ agent_logs.stdout }}
          {% endif %}
    
    - name: Fail if agent not active
      fail:
        msg: |
          ❌ K3S agent failed to start on {{ inventory_hostname }}
          
          Check logs:
            ssh ansible@{{ inventory_hostname }} 'sudo journalctl -xeu k3s-agent.service'
      when: agent_active.stdout != "active"

# Verify cluster after all workers join
- name: Verify Worker Nodes
  hosts: masters[0]
  become: yes
  
  tasks:
    - name: Wait for all worker nodes to register
      shell: /usr/local/bin/k3s kubectl get nodes --selector='!node-role.kubernetes.io/control-plane' --no-headers | wc -l
      register: worker_count
      retries: 12
      delay: 10
      until: worker_count.stdout | int == groups['workers'] | length
      changed_when: false
    
    - name: Get all cluster nodes
      shell: /usr/local/bin/k3s kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false
    
    - name: Display cluster status
      debug:
        msg: |
          ✅ K3S Cluster Status
          
          {{ cluster_nodes.stdout }}
          
          Total Masters: {{ groups['masters'] | length }}
          Total Workers: {{ groups['workers'] | length }}
          
          Cluster is ready for workloads!